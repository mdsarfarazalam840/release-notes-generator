#!/usr/bin/env python3
"""
Test script for Confluence integration.
"""

import os
import sys
from pathlib import Path
import requests
from datetime import datetime

# Add src to path for imports
sys.path.append('src')

try:
    from src.utils import env
    from src.publish_to_confluence import publish
except ImportError:
    print("âŒ Error: Could not import required modules")
    print("Make sure you're running from the project root directory")
    sys.exit(1)


def test_confluence_connection():
    """Test basic Confluence API connection."""
    print("ğŸ§ª Testing Confluence Connection...")
    print("=" * 40)
    
    base_url = env('CONFLUENCE_BASE')
    username = env('CONFLUENCE_USER')
    api_token = env('CONFLUENCE_API_TOKEN')
    
    print(f"Base URL: {base_url or 'Not set'}")
    print(f"Username: {username or 'Not set'}")
    print(f"API Token: {'Set' if api_token else 'Not set'}")
    
    if not all([base_url, username, api_token]):
        print("\nâŒ Confluence not configured. Please run:")
        print("1. Create API token: https://id.atlassian.com/manage-profile/security/api-tokens")
        print("2. Add to .env file:")
        print("   CONFLUENCE_BASE=https://yourcompany.atlassian.net")
        print("   CONFLUENCE_USER=your-email@company.com")
        print("   CONFLUENCE_API_TOKEN=your_token")
        return False
    
    try:
        headers = {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }
        
        auth = (username, api_token)
        test_url = f"{base_url}/rest/api/space"
        
        print(f"\nğŸ” Testing connection to: {test_url}")
        response = requests.get(test_url, headers=headers, auth=auth, timeout=10)
        
        if response.status_code == 200:
            spaces = response.json()
            space_count = len(spaces.get('results', []))
            print(f"âœ… Connection successful! Found {space_count} spaces.")
            
            if space_count > 0:
                print("\nğŸ“ Available spaces:")
                for space in spaces.get('results', [])[:5]:
                    print(f"  â€¢ {space.get('name')} ({space.get('key')})")
            
            return True
            
        elif response.status_code == 401:
            print("âŒ Authentication failed. Check your email and API token.")
            return False
        elif response.status_code == 403:
            print("âŒ Access denied. Check your permissions.")
            return False
        else:
            print(f"âŒ Connection failed: HTTP {response.status_code}")
            print(f"Response: {response.text}")
            return False
            
    except Exception as e:
        print(f"âŒ Connection test failed: {e}")
        return False


def test_confluence_publishing():
    """Test publishing a sample release note to Confluence."""
    print("\nğŸš€ Testing Confluence Publishing...")
    print("=" * 40)
    
    # Create a test release note
    test_version = f"v1.0.0-test-{datetime.now().strftime('%Y%m%d-%H%M%S')}"
    test_content = f"""# Release Notes {test_version}

## ğŸ‰ Test Release

This is a test release note generated by the Release Notes Generator.

### âœ¨ Features
- Test feature 1
- Test feature 2

### ğŸ› Bug Fixes
- Fixed test issue 1
- Fixed test issue 2

### ğŸ“ Notes
- Generated on: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
- This is a test publication

---
*Generated by Release Notes Generator*
"""
    
    # Save to temporary file
    test_file = Path(f'tmp_test_release_{test_version}.md')
    test_file.write_text(test_content, encoding='utf-8')
    
    print(f"ğŸ“„ Created test file: {test_file}")
    print(f"ğŸ“ Version: {test_version}")
    
    try:
        # Test publishing
        print("\nğŸ“¤ Publishing to Confluence...")
        result = publish(test_version, str(test_file))
        
        if result and 'id' in result:
            print("âœ… Publishing successful!")
            print(f"ğŸ“„ Page ID: {result.get('id')}")
            print(f"ğŸ“ Title: {result.get('title')}")
            
            if '_links' in result and 'webui' in result['_links']:
                print(f"ğŸ”— URL: {result['_links']['webui']}")
            
            return True
        else:
            print("âŒ Publishing failed - no page ID returned")
            return False
            
    except Exception as e:
        print(f"âŒ Publishing failed: {e}")
        return False
    
    finally:
        # Clean up test file
        if test_file.exists():
            test_file.unlink()
            print(f"ğŸ§¹ Cleaned up test file: {test_file}")


def test_confluence_api_endpoint():
    """Test the Confluence API endpoint in the server."""
    print("\nğŸŒ Testing Confluence API Endpoint...")
    print("=" * 40)
    
    try:
        response = requests.post('http://localhost:5000/api/confluence/test')
        
        if response.status_code == 200:
            data = response.json()
            print("âœ… API endpoint working!")
            print(f"Status: {data.get('status')}")
            print(f"Message: {data.get('message')}")
            return True
        else:
            data = response.json() if response.headers.get('content-type', '').startswith('application/json') else {}
            print(f"âŒ API endpoint failed: HTTP {response.status_code}")
            print(f"Error: {data.get('error', 'Unknown error')}")
            return False
            
    except requests.ConnectionError:
        print("âŒ Could not connect to server. Make sure it's running:")
        print("python run_enhanced_server.py")
        return False
    except Exception as e:
        print(f"âŒ API test failed: {e}")
        return False


def main():
    """Run all Confluence tests."""
    print("ğŸ§ª CONFLUENCE INTEGRATION TEST SUITE")
    print("=" * 50)
    
    tests_passed = 0
    total_tests = 3
    
    # Test 1: Connection
    if test_confluence_connection():
        tests_passed += 1
    
    # Test 2: API Endpoint
    if test_confluence_api_endpoint():
        tests_passed += 1
    
    # Test 3: Publishing (only if connection works)
    if tests_passed >= 1:
        if test_confluence_publishing():
            tests_passed += 1
    else:
        print("\nâš ï¸ Skipping publishing test due to connection failure")
    
    # Summary
    print(f"\nğŸ“Š TEST RESULTS: {tests_passed}/{total_tests} passed")
    
    if tests_passed == total_tests:
        print("ğŸ‰ All tests passed! Confluence integration is working perfectly.")
        print("\nâœ… You can now:")
        print("1. Use the Confluence checkbox in the UI")
        print("2. Auto-publish release notes to Confluence")
        print("3. Share release notes with your team")
    else:
        print("âš ï¸ Some tests failed. Please check the configuration.")
        print("\nğŸ”§ To fix:")
        print("1. Verify your .env file has correct Confluence settings")
        print("2. Check your API token is valid")
        print("3. Ensure you have Confluence permissions")
    
    return tests_passed == total_tests


if __name__ == '__main__':
    success = main()
    sys.exit(0 if success else 1)